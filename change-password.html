<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trocar Senha - Consulta Lotericas</title>
  <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="auth.css" />
</head>
<body class="auth-page">
  <div class="auth-shell">
    <div class="auth-card">
      <h1>Trocar Senha</h1>
      <p>Senha obrigatória no primeiro acesso. Crie algo seguro para esta máquina.</p>
      <div class="auth-pill" id="changeUserInfo"></div>
      <form id="changePasswordForm">
        <div class="auth-fieldset">
          <label for="newPassword">Nova senha</label>
          <input id="newPassword" type="password" autocomplete="new-password" required />
        </div>
        <div class="auth-fieldset">
          <label for="confirmPassword">Confirmar senha</label>
          <input id="confirmPassword" type="password" autocomplete="new-password" required />
        </div>
        <p class="auth-error" id="changeError" aria-live="polite"></p>
        <ul class="auth-rules">
          <li data-rule="length">Mínimo de 8 caracteres</li>
          <li data-rule="uppercase">Pelo menos 1 letra maiúscula</li>
          <li data-rule="lowercase">Pelo menos 1 letra minúscula</li>
          <li data-rule="number">Pelo menos 1 número</li>
          <li data-rule="symbol">Pelo menos 1 símbolo especial</li>
        </ul>
        <div class="auth-actions">
          <button type="submit">Salvar</button>
        </div>
      </form>
    </div>
  </div>
  <script src="auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const user = window.requireAuthOrRedirect ? window.requireAuthOrRedirect({ allowChangePasswordPage: true }) : null;
      if (!user) {
        return;
      }
      const userInfo = document.getElementById('changeUserInfo');
      if (userInfo) {
        userInfo.textContent = `${user.name} (${user.id})`;
      }

      const form = document.getElementById('changePasswordForm');
      const errorField = document.getElementById('changeError');
      const newPassword = document.getElementById('newPassword');
      const confirmPassword = document.getElementById('confirmPassword');
      const ruleMap = {
        length: document.querySelector('[data-rule="length"]'),
        uppercase: document.querySelector('[data-rule="uppercase"]'),
        lowercase: document.querySelector('[data-rule="lowercase"]'),
        number: document.querySelector('[data-rule="number"]'),
        symbol: document.querySelector('[data-rule="symbol"]'),
      };

      const checkPassword = (value) => {
        const result = {
          length: value.length >= 8,
          uppercase: /[A-Z]/.test(value),
          lowercase: /[a-z]/.test(value),
          number: /\d/.test(value),
          symbol: /[^A-Za-z0-9]/.test(value),
        };
        Object.entries(result).forEach(([key, valid]) => {
          const element = ruleMap[key];
          if (element) {
            element.classList.toggle('valid', valid);
          }
        });
        return result;
      };

      const refreshRules = () => checkPassword(newPassword.value);
      newPassword.addEventListener('input', refreshRules);

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        errorField.textContent = '';
        const candidate = newPassword.value;
        const confirm = confirmPassword.value;
        const checks = checkPassword(candidate);
        const allValid = Object.values(checks).every(Boolean);
        if (!allValid) {
          errorField.textContent = 'A nova senha não atende aos requisitos mínimos.';
          return;
        }
        if (candidate !== confirm) {
          errorField.textContent = 'As senhas não conferem.';
          return;
        }
        try {
          await window.changePassword(candidate);
          window.location.href = 'index.html';
        } catch (err) {
          errorField.textContent = err && err.message ? err.message : 'Falha ao atualizar a senha.';
        }
      });
    });
  </script>
</body>
</html>
